<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Projects - Interia Decor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="../../assets/css/admin.css">
  <style>
    .fixed-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      opacity: 1;
      transition: opacity 0.5s ease;
      animation: slideIn 0.3s ease forwards;
    }
    .fixed-alert.fade-out {
      opacity: 0;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Sidebar -->
    <div class="admin-sidebar">
      <div class="sidebar-header">
        <img src="../../assets/images/logo-white.png" alt="Interia Decor">
        <h3>Admin Panel</h3>
      </div>
      <ul class="sidebar-nav">
        <li><a href="../dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li>
          <a href="#content-collapse" data-bs-toggle="collapse">
            <i class="fas fa-edit"></i> Content <i class="fas fa-chevron-down"></i>
          </a>
          <ul class="collapse" id="content-collapse">
            <li><a href="content-home.html">Home Page</a></li>
            <li class="active"><a href="content-projects.html">Projects</a></li>
            <li><a href="content-testimonials.html">Testimonials</a></li>
            <li><a href="content-services.html">Services</a></li>
          </ul>
        </li>
        <li><a href="settings-design.html"><i class="fas fa-palette"></i> Design Settings</a></li>
        <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
      </ul>
    </div>
    
    <!-- Main Content -->
    <div class="admin-main">
      <div class="admin-header">
        <h2>Manage Projects</h2>
        <div class="user-info">
          <span>Welcome, Admin</span>
        </div>
      </div>
      
      <div class="admin-content">
        <div class="table-responsive">
          <table class="table crud-table" data-endpoint="projects">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Type</th>
                <th>Location</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="projects-table">
              <!-- Projects loaded via JS -->
            </tbody>
          </table>
        </div>
        
        <button class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#projectModal">
          <i class="fas fa-plus"></i> Add New Project
        </button>
      </div>
    </div>
  </div>

  <!-- Project Modal -->
  <div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="projectModalTitle">Add New Project</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="project-form">
            <input type="hidden" id="project-id" name="id">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="project-title" class="form-label">Title</label>
                  <input type="text" class="form-control" id="project-title" name="title" required>
                </div>
                <div class="form-group">
                  <label for="project-type" class="form-label">Type</label>
                  <select class="form-select" id="project-type" name="type" required>
                    <option value="">Select Type</option>
                    <option value="Residential">Residential</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Hospitality">Hospitality</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="project-location" class="form-label">Location</label>
                  <input type="text" class="form-control" id="project-location" name="location">
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-group">
                  <label for="project-area" class="form-label">Area (sq ft)</label>
                  <input type="text" class="form-control" id="project-area" name="area">
                </div>
                <div class="form-group">
                  <label for="project-completed" class="form-label">Completion Date</label>
                  <input type="text" class="form-control" id="project-completed" name="completed">
                </div>
                <div class="form-group">
                  <label for="project-image" class="form-label">Project Image</label>
                  <input type="file" class="form-control" id="project-image" name="image" accept="image/*">
                </div>
              </div>
            </div>
            <div class="form-group">
              <label for="project-description" class="form-label">Description</label>
              <textarea class="form-control" id="project-description" name="description" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="save-project-btn">Save Project</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../../assets/js/admin/auth.js"></script>
  <script src="../../assets/js/admin/crud.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Load projects
      await loadProjectsTable();
      
      // Initialize modal
      const projectModal = document.getElementById('projectModal');
      if (projectModal) {
        projectModal.addEventListener('show.bs.modal', function(event) {
          const button = event.relatedTarget;
          const projectId = button.getAttribute('data-id');
          
          const modalTitle = projectModal.querySelector('.modal-title');
          const saveBtn = projectModal.querySelector('#save-project-btn');
          
          if (projectId) {
            // Edit mode
            modalTitle.textContent = 'Edit Project';
            saveBtn.textContent = 'Update Project';
            loadProjectData(projectId);
          } else {
            // Add mode
            modalTitle.textContent = 'Add New Project';
            saveBtn.textContent = 'Save Project';
            document.getElementById('project-form').reset();
            document.getElementById('project-id').value = '';
          }
        });
      }
      
      // Save project
      document.getElementById('save-project-btn').addEventListener('click', async function() {
        try {
          const formData = getFormData('project-form');
          const projectId = document.getElementById('project-id').value;
          
          if (!formData.title || !formData.type) {
            throw new Error('Title and Type are required fields');
          }
          
          let result;
          if (projectId) {
            result = await projectsCRUD.update(projectId, formData);
            showAlert('Project updated successfully!', 'success');
          } else {
            result = await projectsCRUD.create(formData);
            showAlert('Project created successfully!', 'success');
          }
          
          if (result) {
            await loadProjectsTable();
            bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
          } else {
            throw new Error('Failed to save project');
          }
        } catch (error) {
          console.error('Error:', error);
          showAlert(error.message, 'error');
        }
      });
      
      // Delete project
      document.getElementById('projects-table').addEventListener('click', async function(e) {
        if (e.target.classList.contains('fa-trash') || e.target.parentElement.classList.contains('delete')) {
          e.preventDefault();
          const projectId = e.target.getAttribute('data-id') || 
                           e.target.parentElement.getAttribute('data-id');
          
          if (confirm('Are you sure you want to delete this project?')) {
            try {
              const success = await projectsCRUD.delete(projectId);
              if (success) {
                await loadProjectsTable();
                showAlert('Project deleted successfully!', 'success');
              } else {
                throw new Error('Delete operation failed');
              }
            } catch (error) {
              console.error('Error:', error);
              showAlert('Failed to delete project: ' + error.message, 'error');
            }
          }
        }
        
        // Edit project
        if (e.target.classList.contains('fa-edit') || e.target.parentElement.classList.contains('edit')) {
          e.preventDefault();
          const projectId = e.target.getAttribute('data-id') || 
                           e.target.parentElement.getAttribute('data-id');
          
          const editBtn = document.createElement('button');
          editBtn.setAttribute('data-bs-toggle', 'modal');
          editBtn.setAttribute('data-bs-target', '#projectModal');
          editBtn.setAttribute('data-id', projectId);
          editBtn.style.display = 'none';
          document.body.appendChild(editBtn);
          editBtn.click();
          editBtn.remove();
        }
      });
    });
    
    async function loadProjectsTable() {
      try {
        const projects = await projectsCRUD.getAll();
        const tableBody = document.getElementById('projects-table');
        
        if (!tableBody) return;
        
        tableBody.innerHTML = projects.map(project => `
          <tr>
            <td>${project.id || ''}</td>
            <td>${project.title || ''}</td>
            <td>${project.type || ''}</td>
            <td>${project.location || ''}</td>
            <td class="table-actions">
              <a href="#" class="edit" data-id="${project.id}"><i class="fas fa-edit"></i></a>
              <a href="#" class="delete" data-id="${project.id}"><i class="fas fa-trash"></i></a>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading projects:', error);
        showAlert('Failed to load projects: ' + error.message, 'error');
      }
    }
    
    async function loadProjectData(id) {
      try {
        const project = await projectsCRUD.getById(id);
        if (!project) {
          throw new Error('Project not found');
        }
        
        document.getElementById('project-id').value = id;
        populateForm('project-form', project);
      } catch (error) {
        console.error('Error loading project data:', error);
        showAlert('Failed to load project: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>